<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CBMC: Function Contracts</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CBMC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('contracts-functions.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Function Contracts </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md91">Overview</a></li>
<li class="level1"><a href="#autotoc_md92">Additional Resources</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md__home_runner_work_cbmc_cbmc_src_goto_instrument_contracts_doc_user_contracts_functions"></a> Back to <a class="el" href="contracts-user.html">Code Contracts User Documentation</a></p>
<h1><a class="anchor" id="autotoc_md91"></a>
Overview</h1>
<p>Take a look at the example below.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define SUCCESS 0</span></div>
<div class="line"><span class="preprocessor">#define FAILURE -1</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> sum(<span class="keyword">const</span> uint32_t a, <span class="keyword">const</span> uint32_t b, uint32_t* out)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> uint64_t result = ((uint64_t) a) + ((uint64_t) b);</div>
<div class="line">  <span class="keywordflow">if</span> (result &gt; UINT32_MAX) <span class="keywordflow">return</span> FAILURE;</div>
<div class="line">  *out = (uint32_t) result;</div>
<div class="line">  <span class="keywordflow">return</span> SUCCESS;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// the proof harness</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="file__converter_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>()</div>
<div class="line">{</div>
<div class="line">  uint32_t a;</div>
<div class="line">  uint32_t b;</div>
<div class="line">  uint32_t out;</div>
<div class="line">  <span class="keywordtype">int</span> rval = sum(a, b, &amp;out);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="afile__converter_8cpp_html_a0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="file__converter_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div><div class="ttdef"><b>Definition:</b> <a href="file__converter_8cpp_source.html#l00041">file_converter.cpp:41</a></div></div>
</div><!-- fragment --><p>Function <code>sum</code> writes the sum of <code>a</code> and <code>b</code> to <code>out</code>, and returns <code>SUCCESS</code>; unless the result of the addition is too large to be represented as an <code>uint32_t</code>, in which case it returns <code>FAILURE</code>. Let's write a function contract for this function.</p>
<p>Function contracts are specified by attaching specification clauses to function declarations or definitions:</p><ul>
<li><a class="el" href="contracts-requires-ensures.html">Requires and Ensures Clauses</a> allow to specify preconditions and post conditions,</li>
<li><a class="el" href="contracts-assigns.html">Assigns Clauses</a> allow to specify the assignable memory footprint of a function,</li>
<li><a class="el" href="contracts-frees.html">Frees Clauses</a> allow to specify the set of pointers that may be freed by the function.</li>
</ul>
<p>The following built-in constructs can also be used with functions contracts:</p><ul>
<li><a class="el" href="contracts-history-variables.html">History Variables</a> allow to refer to past versions of function parameters,</li>
<li><a class="el" href="contracts-quantifiers.html">Quantifiers</a> allow to express quantified formulas,</li>
<li><a class="el" href="contracts-memory-predicates.html">Memory Predicates</a> allow to describe simple heap structures;</li>
<li><a class="el" href="contracts-function-pointer-predicates.html">Function Pointer Predicates</a> allow to describe function pointer properties;</li>
</ul>
<p>In our example, the developer may require from the caller to properly allocate all arguments, thus, pointers must be valid. We can specify the preconditions of a function using <code>__CPROVER_requires</code> (see the <a href="../../contracts/requires-and-ensures/">Requires &amp; Ensures Clauses</a> documentation for details) and we can specify an allocated object using a predicate called <code>__CPROVER_is_fresh</code> (see <a class="el" href="contracts-memory-predicates.html">Memory Predicate</a> for details). Thus, for the <code>sum</code> function, the set of preconditions are</p>
<div class="fragment"><div class="line"><span class="comment">/* Precondition */</span></div>
<div class="line">__CPROVER_requires(<a class="code" href="cprover__builtin__headers_8h.html#ad4e9673ed79a6d8ff4af6cf12d95c29f">__CPROVER_is_fresh</a>(out, <span class="keyword">sizeof</span>(*out)))</div>
<div class="ttc" id="acprover__builtin__headers_8h_html_ad4e9673ed79a6d8ff4af6cf12d95c29f"><div class="ttname"><a href="cprover__builtin__headers_8h.html#ad4e9673ed79a6d8ff4af6cf12d95c29f">__CPROVER_is_fresh</a></div><div class="ttdeci">__CPROVER_bool __CPROVER_is_fresh(const void *mem, __CPROVER_size_t size)</div></div>
</div><!-- fragment --><p>We can use <code>__CPROVER_ensures</code> to specify postconditions (see <a href="../../contracts/requires-and-ensures/">Requires &amp; Ensures Clauses</a> for details). In our example, developers can use the built-in construct <code>__CPROVER_return_value</code>, which represents the return value of a function. As postconditions, one may list possible return values (in this case, either <code>SUCCESS</code> or <code>FAILURE</code>) as well as describe the main property of this function: if the function returns <code>SUCCESS</code>, then <code>*out</code> stores the result of <code>a + b</code>. We can also check that the value in <code>*out</code> will be preserved in case of failure by using <code>__CPROVER_old</code>, which refers to the value of a given object in the pre-state of a function (see <a class="el" href="contracts-history-variables.html">History Variables</a> for details). Thus, for the <code>sum</code> function, the set of postconditions are</p>
<div class="fragment"><div class="line"><span class="comment">/* Postconditions */</span></div>
<div class="line">__CPROVER_ensures(__CPROVER_return_value == SUCCESS || __CPROVER_return_value == FAILURE)</div>
<div class="line">__CPROVER_ensures((__CPROVER_return_value == SUCCESS) ==&gt; (*out == (a + b)))</div>
<div class="line">__CPROVER_ensures((__CPROVER_return_value == FAILURE) ==&gt; (*out == <a class="code" href="cprover__builtin__headers_8h.html#a10645790184f1c29e831659a4fd568bb">__CPROVER_old</a>(*out)))</div>
<div class="ttc" id="acprover__builtin__headers_8h_html_a10645790184f1c29e831659a4fd568bb"><div class="ttname"><a href="cprover__builtin__headers_8h.html#a10645790184f1c29e831659a4fd568bb">__CPROVER_old</a></div><div class="ttdeci">void __CPROVER_old(const void *)</div></div>
</div><!-- fragment --><p>Finally, the <em>assigns</em> clause allows developers to define a frame condition (see <a class="el" href="contracts-assigns.html">Assigns Clause</a> for details). In general, systems for describing the frame condition of a function use either writes or modifies semantics; this design is based on the former. This means that memory not specified by the assigns clause must not be written within the given function scope, even if the value(s) therein are not modified. In our example, since we expect that only the value that <code>out</code> points to may be modified, we annotate the function using <code>__CPROVER_assigns(*out)</code>.</p>
<div class="fragment"><div class="line"><span class="comment">/* Write Set */</span></div>
<div class="line">__CPROVER_assigns(*out)</div>
</div><!-- fragment --><p>Here is the whole function with its contract.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> sum(<span class="keyword">const</span> uint32_t a, <span class="keyword">const</span> uint32_t b, uint32_t* out)</div>
<div class="line"><span class="comment">/* Precondition */</span></div>
<div class="line">__CPROVER_requires(<a class="code" href="cprover__builtin__headers_8h.html#ad4e9673ed79a6d8ff4af6cf12d95c29f">__CPROVER_is_fresh</a>(out, <span class="keyword">sizeof</span>(*out)))</div>
<div class="line"><span class="comment">/* Postconditions */</span></div>
<div class="line">__CPROVER_ensures(__CPROVER_return_value == SUCCESS || __CPROVER_return_value == FAILURE)</div>
<div class="line">__CPROVER_ensures((__CPROVER_return_value == SUCCESS) ==&gt; (*out == (a + b)))</div>
<div class="line">__CPROVER_ensures((__CPROVER_return_value == FAILURE) ==&gt; (*out == <a class="code" href="cprover__builtin__headers_8h.html#a10645790184f1c29e831659a4fd568bb">__CPROVER_old</a>(*out)))</div>
<div class="line"><span class="comment">/* Write Set */</span></div>
<div class="line">__CPROVER_assigns(*out)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> uint64_t result = ((uint64_t) a) + ((uint64_t) b);</div>
<div class="line">  <span class="keywordflow">if</span> (result &gt; UINT32_MAX) <span class="keywordflow">return</span> FAILURE;</div>
<div class="line">  *out = (uint32_t) result;</div>
<div class="line">  <span class="keywordflow">return</span> SUCCESS;</div>
<div class="line">}</div>
</div><!-- fragment --><p>First, we have to prove that the function satisfies the contract.</p>
<div class="fragment"><div class="line">goto-cc -o sum.goto *.c --function sum</div>
<div class="line">goto-instrument --enforce-contract sum sum.goto sum-checking-contracts.goto</div>
<div class="line">cbmc sum-checking-contracts.goto --function sum</div>
</div><!-- fragment --><p>The first command just compiles the GOTO program as usual, the second command instruments the code to check the function satisfies the contract, and the third one runs CBMC to do the checking.</p>
<p>In order to start the analysis in an arbitrary state when a function contract gets checked, the contract instrumentation pass automatically havocs all static variables of the program. To avoid havocing certain static variables, the command line switch <code>--nondet-static-exclude name-of-variable</code> can be passed to <code>goto-instrument</code> in addition to the other swtiches specifying the contract to check.</p>
<p>Now that we have proved that the function satisfies the contract, we can use the function contract in place of the function implementation wherever the function is called.</p>
<div class="fragment"><div class="line">goto-cc -o foo.goto *.c --function foo</div>
<div class="line">goto-instrument --replace-call-with-contract sum foo.goto foo-using-sum-contract.goto</div>
<div class="line">cbmc foo-using-sum-contract.goto --function foo</div>
</div><!-- fragment --><p>The first command just compiles the GOTO program as usual, the second command instruments the code to use the function contract in place of the function implementation wherever is invoked, and the third one runs CBMC to check the program using contracts.</p>
<h1><a class="anchor" id="autotoc_md92"></a>
Additional Resources</h1>
<ul>
<li><a class="el" href="contracts-functions.html">Function Contracts</a><ul>
<li><a class="el" href="contracts-requires-ensures.html">Requires and Ensures Clauses</a></li>
<li><a class="el" href="contracts-assigns.html">Assigns Clauses</a></li>
<li><a class="el" href="contracts-frees.html">Frees Clauses</a></li>
</ul>
</li>
<li><a class="el" href="contracts-loops.html">Loop Contracts</a><ul>
<li><a class="el" href="contracts-loop-invariants.html">Loop Invariant Clauses</a></li>
<li><a class="el" href="contracts-decreases.html">Decreases Clauses</a></li>
<li><a class="el" href="contracts-assigns.html">Assigns Clauses</a></li>
<li><a class="el" href="contracts-frees.html">Frees Clauses</a></li>
</ul>
</li>
<li><a class="el" href="contracts-memory-predicates.html">Memory Predicates</a></li>
<li><a class="el" href="contracts-function-pointer-predicates.html">Function Pointer Predicates</a></li>
<li><a class="el" href="contracts-history-variables.html">History Variables</a></li>
<li><a class="el" href="contracts-quantifiers.html">Quantifiers</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="contracts-mainpage.html">Code Contracts in CBMC</a></li><li class="navelem"><a class="el" href="contracts-user.html">Code Contracts User Documentation</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
