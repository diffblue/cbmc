<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CBMC: Checking a Contract Against a Function</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CBMC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('contracts-dev-spec-contract-checking.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Checking a Contract Against a Function </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md32">Swapping-and-Wrapping Functions</a></li>
<li class="level1"><a href="#autotoc_md33">Wrapping Recursive Functions</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md__home_runner_work_cbmc_cbmc_src_goto_instrument_contracts_doc_developer_contracts_dev_spec_contract_checking"></a> Back to top <a class="el" href="contracts-dev-spec.html">Code Contracts Transformation Specification</a></p>
<h1><a class="anchor" id="autotoc_md32"></a>
Swapping-and-Wrapping Functions</h1>
<p>The first operation one can do with contracts is to check if a function satisfies a contract.</p>
<p>Let us consider a contract <code>c</code>, a function <code>foo</code> and a proof harness <code>main</code>.</p>
<div class="fragment"><div class="line"><span class="comment">// A contract</span></div>
<div class="line"><span class="keywordtype">int</span> c(<span class="keywordtype">int</span> *a, <span class="keywordtype">int</span> *b)</div>
<div class="line">__CPROVER_requires(R)</div>
<div class="line">__CPROVER_ensures(E)</div>
<div class="line">__CPROVER_assigns(A)</div>
<div class="line">__CPROVER_frees(F)</div>
<div class="line">;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// A function</span></div>
<div class="line"><span class="keywordtype">int</span> foo(<span class="keywordtype">int</span> *a, <span class="keywordtype">int</span> *b)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// does something with a and b</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// A proof harness for foo</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="file__converter_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// allocate non-deterministic parameters</span></div>
<div class="line">  <span class="keywordtype">int</span> *a = ...;</div>
<div class="line">  <span class="keywordtype">int</span> *b = ...;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// call the function under verification</span></div>
<div class="line">  foo(a, b);</div>
<div class="line">}</div>
<div class="ttc" id="afile__converter_8cpp_html_a0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="file__converter_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div><div class="ttdef"><b>Definition:</b> <a href="file__converter_8cpp_source.html#l00041">file_converter.cpp:41</a></div></div>
</div><!-- fragment --><p>In order to check the contract <code>c</code> against <code>foo</code> in the context set up by the harness <code>main</code>, we apply a <em>swap-and-wrap</em> transformation to the function <code>foo</code>:</p>
<p>The <b>swapping step</b> consists in creating a fresh function <code>foo_swapped</code> with the same interface as <code>foo</code> and swapping the body of <code>foo</code> into <code>foo_swapped</code>, while instrumenting it for <a class="el" href="contracts-dev-spec-dfcc.html">frame condition checking</a> against A and F.</p>
<div class="fragment"><div class="line"><span class="comment">// The old foo function</span></div>
<div class="line"><span class="keywordtype">int</span> foo_swapped(<span class="keywordtype">int</span> *a, <span class="keywordtype">int</span> *b)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// does something with a and b (now checked against A and F)</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>The <b>wrapping step</b> consists in creating a new body for <code>foo</code> where the swapped function gets called between precondition and postcondition checking instructions generated from the contract:</p>
<div class="fragment"><div class="line"><span class="comment">// The old foo function</span></div>
<div class="line"><span class="keywordtype">int</span> foo(<span class="keywordtype">int</span> *a, <span class="keywordtype">int</span> *b)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// preconditions code goes here</span></div>
<div class="line">  <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span> reval = foo_swapped(a, b);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// postconditions code code goes here</span></div>
<div class="line">  <span class="comment">// ...</span></div>
<div class="line">  <span class="keywordflow">return</span> retval;</div>
<div class="line">}</div>
</div><!-- fragment --><p>After the <em>swap-and-wrap</em> transformation is applied, the <code>main</code> function calls the contract-checking wrapper. Analysing this model with CBMC will effectively check that the initial <code>foo</code> (now <code>foo_swapped</code>), under the assumption that the contract preconditions hold, satisfies the postconditions and the frame conditions of the contract.</p>
<div class="fragment"><div class="line"><span class="comment">// add these static variables to the model</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> foo_check_started = <span class="keyword">false</span>;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> foo_check_completed = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">ret_t foo(foo-parameters, write_set_t caller_write_set) {</div>
<div class="line"> </div>
<div class="line">  assert(!foo_check_started, <span class="stringliteral">&quot;recursive calls to foo not allowed&quot;</span>);</div>
<div class="line">  assert(!foo_check_completed, <span class="stringliteral">&quot;foo can only be called once from the harness&quot;</span>);</div>
<div class="line">  foo_check_started = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// create an empty write set to check for side effects in requires clauses</span></div>
<div class="line">  <a class="code" href="struct_____c_p_r_o_v_e_r__contracts__write__set__t.html">__CPROVER_contracts_write_set_t</a> __requires_write_set;</div>
<div class="line">  <a class="code" href="struct_____c_p_r_o_v_e_r__contracts__write__set__t.html">__CPROVER_contracts_write_set_ptr_t</a> requires_write_set = &amp; __requires_write_set;</div>
<div class="line">  <a class="code" href="cprover__contracts_8c.html#ab79449fced8abf348ef2c38bc7cce15a">__CPROVER_contracts_write_set_create</a>(requires_write_set, 0, 0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// assume requires clauses</span></div>
<div class="line">  assume(contract::requires(foo_params, requires_write_set));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// check that requires clause do not allocate or deallocate dynamic memory</span></div>
<div class="line">  assert(__CPROVER_contracts_write_set_allocated_deallocated_is_empty(requires_write_set));</div>
<div class="line">  <a class="code" href="cprover__contracts_8c.html#a6b104b988f01f52cacd9dec8b2621c79">__CPROVER_contracts_write_set_release</a>(requires_write_set);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// snapshot history variables</span></div>
<div class="line">  hist1_t hist1 = ...;</div>
<div class="line">  hist2_t hist2 = ...;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// populate the contract write set</span></div>
<div class="line">  <a class="code" href="struct_____c_p_r_o_v_e_r__contracts__write__set__t.html">__CPROVER_contracts_write_set_t</a> __contract_write_set;</div>
<div class="line">  <a class="code" href="struct_____c_p_r_o_v_e_r__contracts__write__set__t.html">__CPROVER_contracts_write_set_ptr_t</a> contract_write_set = &amp;__contract_write_set;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// allocate and populate the contract write set</span></div>
<div class="line">  <a class="code" href="cprover__contracts_8c.html#ab79449fced8abf348ef2c38bc7cce15a">__CPROVER_contracts_write_set_create</a>(contract_write_set, assigns_clause_size(c), frees_clause_size(c));</div>
<div class="line">  contract::assigns(contract_write_set, empty_write_set);</div>
<div class="line">  contract::frees(contract_write_set, empty_write_set);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// call the function</span></div>
<div class="line">  ret_t retval;</div>
<div class="line">  retval = foo_swapped(foo_params, contact_write_set);</div>
<div class="line">  <a class="code" href="cprover__contracts_8c.html#a6b104b988f01f52cacd9dec8b2621c79">__CPROVER_contracts_write_set_release</a>(contract_write_set);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// create an empty write set to check for side effects in requires clauses</span></div>
<div class="line">  <a class="code" href="struct_____c_p_r_o_v_e_r__contracts__write__set__t.html">__CPROVER_contracts_write_set_t</a> __ensures_write_set;</div>
<div class="line">  <a class="code" href="struct_____c_p_r_o_v_e_r__contracts__write__set__t.html">__CPROVER_contracts_write_set_ptr_t</a> ensures_write_set = &amp; __ensures_write_set;</div>
<div class="line">  <a class="code" href="cprover__contracts_8c.html#ab79449fced8abf348ef2c38bc7cce15a">__CPROVER_contracts_write_set_create</a>(ensures_write_set, 0, 0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// check post conditions</span></div>
<div class="line">  assert(contract::ensures(foo_params, ensures_write_set));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// check that requires clause do not allocate or deallocate dynamic memory</span></div>
<div class="line">  assert(__CPROVER_contracts_write_set_allocated_deallocated_is_empty(ensures_write_set));</div>
<div class="line">  <a class="code" href="cprover__contracts_8c.html#a6b104b988f01f52cacd9dec8b2621c79">__CPROVER_contracts_write_set_release</a>(ensures_write_set);</div>
<div class="line"> </div>
<div class="line">  foo_check_completed = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> retval;</div>
<div class="line">}</div>
<div class="ttc" id="acprover__contracts_8c_html_a6b104b988f01f52cacd9dec8b2621c79"><div class="ttname"><a href="cprover__contracts_8c.html#a6b104b988f01f52cacd9dec8b2621c79">__CPROVER_contracts_write_set_release</a></div><div class="ttdeci">void __CPROVER_contracts_write_set_release(__CPROVER_contracts_write_set_ptr_t set)</div><div class="ttdoc">Releases resources used by set.</div><div class="ttdef"><b>Definition:</b> <a href="cprover__contracts_8c_source.html#l00449">cprover_contracts.c:449</a></div></div>
<div class="ttc" id="acprover__contracts_8c_html_ab79449fced8abf348ef2c38bc7cce15a"><div class="ttname"><a href="cprover__contracts_8c.html#ab79449fced8abf348ef2c38bc7cce15a">__CPROVER_contracts_write_set_create</a></div><div class="ttdeci">void __CPROVER_contracts_write_set_create(__CPROVER_contracts_write_set_ptr_t set, __CPROVER_size_t contract_assigns_size, __CPROVER_size_t contract_frees_size, __CPROVER_bool assume_requires_ctx, __CPROVER_bool assert_requires_ctx, __CPROVER_bool assume_ensures_ctx, __CPROVER_bool assert_ensures_ctx, __CPROVER_bool allow_allocate, __CPROVER_bool allow_deallocate)</div><div class="ttdoc">Initialises a __CPROVER_contracts_write_set_t object.</div><div class="ttdef"><b>Definition:</b> <a href="cprover__contracts_8c_source.html#l00412">cprover_contracts.c:412</a></div></div>
<div class="ttc" id="astruct_____c_p_r_o_v_e_r__contracts__write__set__t_html"><div class="ttname"><a href="struct_____c_p_r_o_v_e_r__contracts__write__set__t.html">__CPROVER_contracts_write_set_t</a></div><div class="ttdoc">Runtime representation of a write set.</div><div class="ttdef"><b>Definition:</b> <a href="cprover__contracts_8c_source.html#l00071">cprover_contracts.c:72</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md33"></a>
Wrapping Recursive Functions</h1>
<p>If the function to be checked is potentially recursive, we generate the wrapper function body such that the first call trigger the contract checking, and any subsequent call triggers the contract replacement logic as described in <a class="el" href="contracts-dev-spec-contract-replacement.html">Replacing a Function by a Contract</a> :</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> foo_check_started = <span class="keyword">false</span>;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> foo_check_completed = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">ret_t foo(foo_params, write_set_t caller_write_set) {</div>
<div class="line">  assert(!foo_check_completed, <span class="stringliteral">&quot;foo can only be called once from the harness&quot;</span>);</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// first call, check the contract</span></div>
<div class="line">  <span class="keywordflow">if</span>(!foo_check_started) {</div>
<div class="line">    <span class="comment">// non-recursive contract checking instructions go here</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">   <span class="keywordflow">return</span> retval;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">// contract replacement instructions</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">    <span class="keywordflow">return</span> retval;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
 <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Prev   </th><th class="markdownTableHeadLeft">Next    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="contracts-dev-spec-harness.html">Proof Harness Intrumentation</a>   </td><td class="markdownTableBodyLeft"><a class="el" href="contracts-dev-spec-contract-replacement.html">Replacing a Function by a Contract</a>   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="contracts-mainpage.html">Code Contracts in CBMC</a></li><li class="navelem"><a class="el" href="contracts-dev.html">Code Contracts Developer Documentation</a></li><li class="navelem"><a class="el" href="contracts-dev-spec.html">Code Contracts Transformation Specification</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
