<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CProver manual: contracts-memory-predicates</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CProver manual
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">contracts-memory-predicates </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href=".">CPROVER Manual TOC</a></p>
<h1><a class="anchor" id="memory-predicates"></a>
Memory Predicates</h1>
<h3><a class="anchor" id="syntax"></a>
Syntax</h3>
<div class="fragment"><div class="line">bool __CPROVER_is_fresh(void *p, size_t size);</div>
</div><!-- fragment --><p>To specify memory footprint we use a special function called <code>__CPROVER_is_fresh</code>. The meaning of <code>__CPROVER_is_fresh</code> is that we are borrowing a pointer from the external environment (in a precondition), or returning it to the calling context (in a postcondition).</p>
<h3><a class="anchor" id="parameters"></a>
Parameters</h3>
<p><code>__CPROVER_is_fresh</code> takes two arguments: a pointer and an allocation size. The first argument is the pointer to be checked for “freshness” (i.e., not previously allocated), and the second is the expected size in bytes for the memory available at the pointer.</p>
<h3><a class="anchor" id="return-value"></a>
Return Value</h3>
<p>It returns a <code>bool</code> value, indicating whether the pointer is fresh.</p>
<h3><a class="anchor" id="semantics"></a>
Semantics</h3>
<p>To illustrate the semantics for <code>__CPROVER_is_fresh</code>, consider the following implementation of <code>sum</code> function.</p>
<div class="fragment"><div class="line">int *err_signal; // Global variable</div>
<div class="line"> </div>
<div class="line">void sum(const uint32_t a, const uint32_t b, uint32_t* out)</div>
<div class="line">__CPROVER_requires(__CPROVER_is_fresh(out, sizeof(*out)))</div>
<div class="line">__CPROVER_ensures(__CPROVER_is_fresh(err_signal, sizeof(*err_signal)))</div>
<div class="line">__CPROVER_assigns(*out, err_signal)</div>
<div class="line">{</div>
<div class="line">  const uint64_t result = ((uint64_t) a) + ((uint64_t) b);</div>
<div class="line">  err_signal = malloc(sizeof(*err_signal));</div>
<div class="line">  if (!err_signal) return;</div>
<div class="line">  if (result &gt; UINT32_MAX) *err_signal = FAILURE;</div>
<div class="line">  *out = (uint32_t) result;</div>
<div class="line">  *err_signal = SUCCESS;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="enforcement"></a>
Enforcement</h4>
<p>When checking the contract abstracts a function a <code>__CPROVER_is_fresh</code> in a <em>requires</em> clause will cause fresh memory to be allocated. In an <em>ensures</em> clause it will check that memory was freshly allocated.</p>
<div class="fragment"><div class="line">int *err_signal; // Global variable</div>
<div class="line"> </div>
<div class="line">int __CPROVER_contracts_original_sum(const uint32_t a, const uint32_t b, uint32_t* out)</div>
<div class="line">{    </div>
<div class="line">  const uint64_t result = ((uint64_t) a) + ((uint64_t) b);</div>
<div class="line">  err_signal = malloc(sizeof(*err_signal));</div>
<div class="line">  if (!err_signal) return;</div>
<div class="line">  if (result &gt; UINT32_MAX) *err_signal = FAILURE;</div>
<div class="line">  *out = (uint32_t) result;</div>
<div class="line">  *err_signal = SUCCESS;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">/* Function Contract Enforcement */</div>
<div class="line">int sum(const uint32_t a, const uint32_t b, uint32_t* out)</div>
<div class="line">{</div>
<div class="line">  __CPROVER_assume(__CPROVER_is_fresh(out, sizeof(*out))); // Assumes out is freshly allocated</div>
<div class="line">  int return_value_sum = __CPROVER_contracts_original_sum(a, b, out);</div>
<div class="line">  __CPROVER_assert(__CPROVER_is_fresh(err_signal, sizeof(*err_signal)), &quot;Check ensures clause&quot;);</div>
<div class="line">  return return_value_sum;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="replacement"></a>
Replacement</h4>
<p>In our example, consider that a function <code>foo</code> may call <code>sum</code>.</p>
<div class="fragment"><div class="line">int *err_signal; // Global variable</div>
<div class="line"> </div>
<div class="line">int foo()</div>
<div class="line">{</div>
<div class="line">  uint32_t a;</div>
<div class="line">  uint32_t b;</div>
<div class="line">  uint32_t out;</div>
<div class="line">  sum(a, b, &amp;out);</div>
<div class="line">  return *err_signal;</div>
<div class="line">}</div>
</div><!-- fragment --><p>When using a contract as an abstraction in place of a call to the function a <code>__CPROVER_is_fresh</code> in a <em>requires</em> clause will check that the argument supplied is fresh and <code>__CPROVER_is_fresh</code> in an <em>ensures</em> clause will result in a fresh malloc.</p>
<div class="fragment"><div class="line">int *err_signal; // Global variable</div>
<div class="line"> </div>
<div class="line">int foo()</div>
<div class="line">{</div>
<div class="line">  uint32_t a;</div>
<div class="line">  uint32_t b;</div>
<div class="line">  uint32_t out;</div>
<div class="line">    </div>
<div class="line">  /* Function Contract Replacement */</div>
<div class="line">  /* Precondition */</div>
<div class="line">  __CPROVER_assert(__CPROVER_is_fresh(out, sizeof(*out)), &quot;Check requires clause&quot;);</div>
<div class="line">    </div>
<div class="line">  /* Writable Set */</div>
<div class="line">  *(&amp;out) = nondet_uint32_t();</div>
<div class="line">  err_signal = nondet_int_pointer();</div>
<div class="line">    </div>
<div class="line">  /* Postconditions */</div>
<div class="line">  __CPROVER_assume(__CPROVER_is_fresh(err_signal, sizeof(*err_signal))); // Assumes out is allocated</div>
<div class="line"> </div>
<div class="line">  return *err_signal;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Last modified: 2022-10-31 09:43:23 +0000 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
